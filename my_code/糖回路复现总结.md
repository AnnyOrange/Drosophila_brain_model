# 糖回路复现总结（my_code 运行结果）

- 环境：`conda run -n flybrain`，单核；`--n-run 2`（为适配沙箱限制缩短试次），频率 100 Hz，输出目录 `results/my_code_sugar/`。
- 生成文件：`results/my_code_sugar/sugarR_100Hz.parquet`。
- 运行状态：Brian2 因权限限制回退到 numpy 后端（仅影响速度，不影响结果）；无报错。

## 与示例输出对比（100 Hz 激活 21 个 sugar GRN）
示例基线：`results/example/sugarR_100Hz.parquet`（默认 n_run=30）

| 指标 | 示例 (n_run=30) | 我的运行 (n_run=2) | 说明 |
| ---- | --------------- | ------------------ | ---- |
| 有响应神经元数 | 404 | 365 | 试次减少导致部分低频神经元未触发 |
| 平均放电率 (Hz) | 23.85 | 26.59 | 少量试次使均值上浮，属采样差异 |
| 中位数 (Hz) | 14.38 | 17.50 | 同上 |
| Top1 | 720575940622695448 (114.27) | 720575940622695448 (114.0) | 一致 |
| Top2 | 720575940621754367 (102.57) | 720575940621754367 (108.0) | 一致 |
| Top3–5 | 720575940617937543 / 629888530 / 629176663 (≈101–102) | 720575940628853239 / 639332736 / 617000768 (≈103–106) | 排名差异来自 n_run 减少的随机波动 |

结论：Top 响应神经元与示例高度一致（前两名完全相同，放电率量级一致），说明激活流程已复现成功；n_run=2 带来的随机性导致中后段排名有差异。

## 复现步骤（已验证）
```bash
# 1) 运行糖回路（100 Hz，试次缩短）
conda run -n flybrain python my_code/sugar_circuit.py --path-res results/my_code_sugar --n-proc 1 --n-run 2 freq --freqs 100

# 2) 汇总速率（无需绘图依赖）
conda run -n flybrain python -c "import utils as utl; from model import default_params; \
rate,_=utl.get_rate(utl.load_exps(['results/my_code_sugar/sugarR_100Hz.parquet']), \
t_run=default_params['t_run'], n_run=2); print(rate.sort_values('sugarR_100Hz', ascending=False).head())"
```

## 若需完全对齐示例/论文
- 移除 `--n-run 2`，使用默认 n_run=30；可尝试 `--n-proc 2`（若权限受限则保持 1）。
- 安装绘图依赖并指定可写缓存：
  ```bash
  conda run -n flybrain pip install matplotlib seaborn
  MPLCONFIGDIR=/tmp/mpl conda run -n flybrain \
    python my_code/sugar_circuit.py --path-res results/my_code_sugar plot --glob "sugarR*.parquet"
  ```
- 切换到 783 数据：加 `--path-comp Completeness_783.csv --path-con Connectivity_783.parquet`。

## 补充：糖路输入神经元的注释（来自 `Supplemental_file1_neuron_annotations.tsv`）
- 21 个 sugar GRN 中有 20 个在注释表中找到，均标注为：
  - `cell_type`: `LB3`
  - `cell_class`: `gustatory`
  - `super_class`: `sensory`
  - `side`: `left`
  - `nerve`: `MxLbN`
  - `top_nt`: `acetylcholine`
- 未匹配到注释的 root ID：`720575940620900446`（表中缺失或未标注）。

## 补充：糖路激活后高响应神经元的注释（示例 vs. 本次运行）
- 示例基线（`results/example/sugarR_100Hz.parquet`, n_run=30，取 Top 15）：
  - 主要两类：  
    - 感觉端：`LB3` 味觉感受神经元（左侧，`sensory`，`MxLbN`，`acetylcholine`）。  
    - 中枢介导：`CB0248`（GABA 预测，左右侧各一）；`CB0192`（左侧，乙酰胆碱预测）。
  - Top15 覆盖 ID 示例：`720575940622695448 (CB0248, gaba, right)`、`720575940627383685 (CB0248, gaba, left)`、`720575940629888530 (CB0192, ach, left)`，其余为 `LB3` 感受神经元。
- 我的运行（`results/my_code_sugar/sugarR_100Hz.parquet`, n_run=2，取 Top 10）：
  - 同样出现中枢 `CB0248` (gaba) 和 `CB0192` (ach)，其余为 `LB3` 感受神经元。  
  - Top10 注释示例：`CB0248`、`CB0192`，以及多条 `LB3`（左侧，MxLbN，acetylcholine）。
- 结论：高响应的核心节点与示例一致——糖感受神经元（`LB3`）及一小撮中枢中间神经元（`CB0248` GABA、`CB0192` ACh），表明激活链路复现成功。

## 输出端验证：MN9（口器运动神经元）
- MN9 的 Flywire root ID：`720575940660219265`，注释表条目：`cell_type=CB0701`、`nerve=PhN`（咽神经，口器相关）、`top_nt=acetylcholine`。
- 示例基线（n_run=30，`results/example/sugarR_100Hz.parquet`）：MN9 放电率 ≈ 67.03 Hz。
- 本次运行（n_run=2，`results/my_code_sugar/sugarR_100Hz.parquet`）：MN9 放电率 ≈ 65.5 Hz。
- 量级与示例一致，可认为糖路激活成功驱动了口器相关的输出神经元（MN9），仅因试次减少存在轻微采样波动。

## 1 秒窗口、5 次试验的 MN9 放电计数（与苦路对比）
- 脚本：`my_code/mn9_spike_hist.py`（t_run=1s，n_run=5，单核，输出到 `results/my_code_hist/`）。
- 糖路每 trial 内 MN9 spikes：`[81, 86, 78, 82, 90]`（总 417），均值 83.4，std 4.67。
- 苦路每 trial 内 MN9 spikes：`[9, 9, 11, 8, 9]`（总 46），均值 9.2，std 1.10。
- 图表：`mn9_sugar_hist.png`、`mn9_bitter_hist.png`、`mn9_sugar_trial_counts.png`、`mn9_bitter_trial_counts.png` 位于 `results/my_code_hist/`。
- 结论：在同样 1 秒刺激下，糖路对 MN9 的激活约为苦路的 9 倍。

## 1 秒窗口、20 次试验（n_run=20）的 MN9 放电计数
- 命令（可分别运行，避免长时间超时）：  
  - 糖：`MPLCONFIGDIR=/tmp/mpl conda run -n flybrain python my_code/mn9_spike_hist.py --mode sugar --n-run 20`  
  - 苦：`MPLCONFIGDIR=/tmp/mpl conda run -n flybrain python my_code/mn9_spike_hist.py --mode bitter --n-run 20`
- 每 trial 内 MN9 spikes：  
  - 糖：`[94, 83, 84, 83, 81, 80, 85, 86, 83, 85, 89, 85, 93, 87, 81, 87, 76, 81, 90, 81]`（总 1694），均值 **84.7**，std **4.45**。  
  - 苦：`[7, 13, 7, 10, 12, 17, 9, 8, 10, 9, 9, 6, 8, 12, 11, 12, 11, 11, 8, 9]`（总 199），均值 **9.95**，std **2.54**。  
- 直方图/散点柱状图及 counts CSV 已覆盖，路径同上（`results/my_code_hist/`）。
- 结论：即使在 20 次重复下，糖路对 MN9 的激活仍明显高于苦路（~8.5–9x），结论稳健。

## 弱刺激测试（糖路，r_poi=50 Hz，n_run=2，1 秒窗口）
- 命令：`MPLCONFIGDIR=/tmp/mpl conda run -n flybrain python my_code/mn9_spike_hist.py --mode sugar --n-run 2 --r-poi 50`
- 结果：每 trial MN9 spikes = `[14, 13]`（总 27），均值 13.5，std 0.71。相较默认 150 Hz 激活，大幅降低，仍有少量放电。

## 苦味回路初步测试（LB2/LB4 苦相关 GRN，100 Hz，n_run=2）
- 输入选择：注释表中口器相关的 gustatory 类型中，与糖路不同的 LB2*/LB4a（共 26 个 root ID）；在 630 完整性表内仅 10 个可用（其余在该版本缺失）。
- 运行命令：
  ```bash
  conda run -n flybrain python my_code/bitter_circuit.py --freqs 100 --n-run 2 --n-proc 1 --path-res results/my_code_bitter --summary
  ```
- 输出：`results/my_code_bitter/bitterR_100Hz.parquet`
- 高响应 Top10（Hz）：115.5, 107.5, 107.0, 104.5, 97.5, 97.0, 96.5, 92.5, 92.0, 90.5（均为 LB2/LB4 系感受神经元）。
- MN9 放电率：约 **18 Hz**，远低于糖路的 65.5 Hz，表明在 100 Hz 苦味输入下 MN9 激活弱，未显著驱动口器伸展。

### 顶部放电神经元（含注释，便于快速识别）
- 糖路（100 Hz，n_run=2，Top5；文件 `results/my_code_sugar/sugarR_100Hz.parquet`）
  1. `720575940622695448` — `cell_type=CB0248`, `super_class=central`, `top_nt=gaba`, side=right  
  2. `720575940621754367` — `cell_type=LB3`, `cell_class=gustatory`, `super_class=sensory`, nerve=MxLbN, `top_nt=acetylcholine`, side=left  
  3. `720575940628853239` — `cell_type=LB3`, gustatory, sensory, MxLbN, acetylcholine, left  
  4. `720575940639332736` — `cell_type=LB3`, gustatory, sensory, MxLbN, acetylcholine, left  
  5. `720575940617000768` — `cell_type=LB3`, gustatory, sensory, MxLbN, acetylcholine, left  

- 苦路（100 Hz，n_run=2，Top5；文件 `results/my_code_bitter/bitterR_100Hz.parquet`）
  1. `720575940628832256` — `cell_type=LB2d`, gustatory, sensory, nerve=MxLbN, side=left  
  2. `720575940620856046` — `cell_type=LB4a`, gustatory, sensory, MxLbN, left  
  3. `720575940627821896` — `cell_type=LB2d`, gustatory, sensory, MxLbN, left  
  4. `720575940622371037` — `cell_type=LB4a`, gustatory, sensory, MxLbN, left  
  5. `720575940637580102` — `cell_type=LB2c`, gustatory, sensory, MxLbN, left  
