# 项目简介
- 关联论文：Phil Shiu 等人（2023），*A leaky integrate-and-fire computational model based on the connectome of the entire adult Drosophila brain reveals insights into sensorimotor processing*（bioRxiv:2023.05.02.539144）。本仓库提供复现论文实验与图表的代码与示例数据。
- 研究核心：基于 Flywire 成年果蝇全脑连接组，构建 leaky integrate-and-fire 模型；支持指定神经元的激活/沉默，输出全脑神经元的放电时间与频率。

## 目录结构（工作区根目录）
- `model.py`：核心模型与仿真驱动。定义默认参数、Poisson 输入、沉默连接、网络创建、单次试验与并行实验运行（`run_exp`）以及结果序列化。
- `utils.py`：结果后处理。包含批量加载仿真 parquet、按试验计算神经元平均放电率与标准差。
- `example.ipynb`：使用教程，展示如何配置神经元激活/沉默并运行仿真。
- `figures.ipynb`：生成论文中的分析与图表（依赖完整仿真输出数据，未随仓库提供）。
- `environment.yml` / `environment_full.yml`：conda 环境配置，前者为精简依赖（Python 3.10、Brian2 2.5.1、numpy/pandas/joblib/pyarrow 等），后者列出论文使用的具体版本。
- 数据文件
  - `2023_03_23_completeness_630_final.csv`、`2023_03_23_connectivity_630_final.parquet`：论文使用的 Flywire 630 版神经元清单与连接矩阵。
  - `Completeness_783.csv`、`Connectivity_783.parquet`：公共 783 版对应数据，需在代码里切换 `config` 路径使用。
  - `Supplemental_file1_neuron_annotations.tsv`：神经元注释信息。
  - `sez_neurons.pickle`：示例神经元子集。
- `results/example/`：示例仿真输出（parquet），用于快速演示分析流程。
- `my_code/`：用户前缀的自定义代码目录（与项目原始文件区分），包含糖路脚本；默认输出到 `results/my_code_sugar`。
- `LICENSE`、`Readme.md`：版权与使用说明。

### `results/example/` 示例文件（来自 `example.ipynb`）
- 全部文件结构一致：列 `t`（秒，spike 时间）、`trial`（试次编号，默认 0–29 共 30 次）、`flywire_id`（发放神经元 ID）、`exp_name`（实验名）。
- `sugarR.parquet`：激活 21 个“sugar sensing”神经元列表（`neu_sugar`），Poisson 频率默认 150 Hz，未沉默任何神经元。
- `sugarR_100Hz.parquet`：同上，但将 `params['r_poi']` 降至 100 Hz。
- `sugarR-<ID>.parquet`（3 个文件，对应 720575940617937543 / 720575940621754367 / 720575940622695448）：在 100 Hz 激活全部 sugar sensing 神经元的同时，分别沉默其中一个最活跃的神经元（`neu_slnc=[ID]`），用于对比沉默效应。

## 核心模块结构
- `model.py`
  - `default_params`：Brian2 模型参数（电生理常数、方程、阈值、权重、Poisson 速率等）。
  - `poi`：为指定神经元添加 PoissonInput，并调整其不应期。
  - `silence`：将指定神经元的全部突触权重置零，实现沉默。
  - `create_model`：从完整性与连接数据帧构建 `NeuronGroup`、`Synapses`、`SpikeMonitor`。
  - `run_trial`：一次激活/沉默试验，返回 spike trains。
  - `run_exp`：并行重复试验、汇总结果并写出 parquet。
- `utils.py`
  - `load_exps`：批量读取仿真 parquet，统一时间格式。
  - `get_rate`：按实验与神经元计算平均放电率及标准差，可附带神经元自定义名称。

### 数据补充：`sez_neurons.pickle`
- 类型：`dict[str, list[int]]`，键为 SEZ（下食管区）神经元/群组名称，值为对应的 Flywire root ID 列表。
- 用途：可直接传给 `run_exp` 的 `neu_exc` 或 `neu_slnc`，快速批量激活/沉默某个 SEZ 群组，常用于在 SEZ 场景下筛查下游响应或测试沉默效应。
- 规模示例：约 90 个键，如 `aDT6`(11 个 ID)、`basket`(15)、`rocket`(18)、`weaver`(13) 等。

### 数据补充：`Supplemental_file1_neuron_annotations.tsv`
- 行数/列：139,244 行、31 列；用制表符分隔。
- 关键字段：`root_id`（Flywire root ID，可与仿真结果的 `flywire_id` 对齐）、`cell_type`、`cell_class`、`supertype`、`super_class`、`side`、`nerve` 等，以及 `pos_*`/`soma_*` 坐标、神经递质预测 (`top_nt`)、性二态 (`dimorphism`) 等。
- 用途：在分析仿真输出（parquet 或 `get_rate` 生成的表）时，可按 `root_id` 关联此文件，为神经元添加类型、侧别、神经递质等注释；也可用来挑选特定类型的神经元作为刺激/沉默列表。

## 783 版数据结构与字段
- `Completeness_783.csv`（138,639 行，2 列）
  - `Unnamed: 0`：Flywire 神经元 root ID（数值型），在代码中作为索引并映射到 Brian2 神经元编号。
  - `Completed`：是否被标记为“完整”的神经元（本文件全为 True）。
- `Connectivity_783.parquet`（15,091,983 行，列见下）
  - `Presynaptic_ID` / `Postsynaptic_ID`：突触前/突触后神经元的 Flywire root ID。
  - `Presynaptic_Index` / `Postsynaptic_Index`：与 `Completeness_783.csv` 顺序一致的 0-based 索引；`model.py` 用它们连接 `Synapses`。
  - `Connectivity`：突触数（非负整数）。
  - `Excitatory`：突触类型，+1 表示兴奋性，-1 表示抑制性。
  - `Excitatory x Connectivity`：将突触类型符号与突触数相乘的权重基数；在 `model.py` 中直接乘以 `w_syn` 作为 Brian2 突触权重。
  - `__index_level_0__`：写 parquet 时留下的索引列，计算中可忽略或丢弃。

### `my_code/`（用户前缀，推荐使用）
- 目的：明确区分“我的代码”和原仓库代码，便于后续维护。
- `sugar_circuit.py`：糖路实验命令行入口，运行时自动把仓库根目录加入 `sys.path`，可直接导入 `model.py`/`utils.py`。
  - 频率扫描：
    ```bash
    python my_code/sugar_circuit.py freq --freqs 25 50 75 100 125 150 175 200 --path-res results/my_code_sugar
    ```
  - 逐个沉默：
    ```bash
    python my_code/sugar_circuit.py silence --freq 100 --silence-ids 720575940617937543 720575940621754367 --path-res results/my_code_sugar
    ```
  - 汇总绘图（需 matplotlib/seaborn）：
    ```bash
    python my_code/sugar_circuit.py plot --glob "sugarR*.parquet" --path-res results/my_code_sugar
    ```
- `README.md`：使用说明与依赖提示（默认 630 版数据，可通过 `--path-comp/--path-con` 换到 783 版）。

## 基本使用流程
1) 创建环境：`conda env create -f environment.yml`（若需与论文完全一致，用 `environment_full.yml`）。  
2) 准备数据：默认使用 630 版完整性与连接数据；切换到 783 版需在脚本/Notebook 的 `config` 中替换路径。  
3) 运行示例：在 `example.ipynb` 里设定 `neu_exc`/`neu_slnc`/`neu_exc2`，调用 `run_exp` 生成 parquet 结果。  
4) 分析结果：用 `utils.get_rate` 计算放电率，或在 `figures.ipynb` 复现论文图表（需完整仿真输出存档）。  
5) 输出位置：仿真结果写入 `results/<exp_name>.parquet`（可在 `config['path_res']` 调整）。

## 额外提示
- 仿真依赖 Brian2，可按 README 建议开启 C++ 代码生成以提高性能。  
- 默认 `n_proc=-1` 使用全部 CPU 核心，可在资源受限环境下调小。  
- 仿真原始完整输出数据过大未随仓库提供，需从 README 链接的 DOI 存档下载。  
